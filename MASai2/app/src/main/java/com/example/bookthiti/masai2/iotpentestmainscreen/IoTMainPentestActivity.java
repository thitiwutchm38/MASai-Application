package com.example.bookthiti.masai2.iotpentestmainscreen;

import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.content.ServiceConnection;
import android.os.IBinder;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.ImageButton;
import android.widget.TextView;
import android.widget.Toast;

import com.example.bookthiti.masai2.Bluetooth_attackActivity;
import com.example.bookthiti.masai2.LogConstants;
import com.example.bookthiti.masai2.MasaiSettingActivity;
import com.example.bookthiti.masai2.R;
import com.example.bookthiti.masai2.bluetoothservice.BluetoothManagementService;
import com.example.bookthiti.masai2.networksearchingscreen.SearchNetworkActivity;

public class IoTMainPentestActivity extends AppCompatActivity {
    private ImageButton mImageButtonSetting;
    private ImageButton mImageButtonDeviceAttack;
    private ImageButton mImageButtonRouterAttack;
    private ImageButton mImageButtonBluetoothAttack;

    private Context mContext;

    private BluetoothManagementService mBluetoothManagementService;
    private boolean mBound = false;
    private boolean isRemoteDeviceConnected = false;

    //TODO: Set broadcast receiver to listen MASai Box disconnection

    private ServiceConnection mConnection = new ServiceConnection() {
        @Override
        public void onServiceConnected(ComponentName name, IBinder service) {
            BluetoothManagementService.LocalBinder binder = (BluetoothManagementService.LocalBinder) service;
            mBluetoothManagementService = binder.getBluetoothManagementServiceInstance();
            mBound = true;
            isRemoteDeviceConnected = isRemoteDeviceConnected();
            TextView textView = (TextView) findViewById(R.id.textView5);
            if(isRemoteDeviceConnected) textView.setText("MASai Box Status: On");
            else textView.setText("MASai Box Status: Off");
        }

        @Override
        public void onServiceDisconnected(ComponentName name) {
            mBound = false;
            Log.i(LogConstants.TAG_INFO, "Service is unbounded");
        }
    };

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_iot_main_pentest);
        mContext = getApplicationContext();

        Intent bindServiceIntent = new Intent(this, BluetoothManagementService.class);
        if(!mBound) {
            bindService(bindServiceIntent, mConnection, Context.BIND_AUTO_CREATE);
        }
        mImageButtonSetting = (ImageButton)findViewById(R.id.imageButton_setup_box);
        mImageButtonDeviceAttack = (ImageButton)findViewById(R.id.imageButton_device_att);
        mImageButtonRouterAttack = (ImageButton)findViewById(R.id.imageButton_router_att);
        mImageButtonBluetoothAttack = (ImageButton)findViewById(R.id.imageButton_ble_att);


        mImageButtonDeviceAttack.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v){
                if(!isRemoteDeviceConnected()) {
                    showRequiredConnection();
                } else openActivity_device_att();
            }
        });

        mImageButtonRouterAttack.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v){
                if(!isRemoteDeviceConnected()) {
                    showRequiredConnection();
                } else openActivity_router_att();
            }
        });

        mImageButtonSetting.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v){
                if(!isRemoteDeviceConnected()) {
                    showRequiredConnection();
                } else openActivity_setting();
            }
        });

        mImageButtonBluetoothAttack.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v){
                if(!isRemoteDeviceConnected()) {
                    showRequiredConnection();
                } else openActivity_bluetooth_att();
            }
        });


    }

    @Override
    protected void onDestroy() {
        if(mBound){
            unbindService(mConnection);
        }
        super.onDestroy();
    }

    public void openActivity_device_att() {

        Intent intent = new Intent(this,SearchNetworkActivity.class);

        //Bundle
        Bundle bundle = new Bundle();
        bundle.putString("MyValue", "device_att");
        intent.putExtras(bundle);

        startActivity(intent);

    }
    public void openActivity_router_att() {

        Intent intent = new Intent(this,SearchNetworkActivity.class);
        //Bundle
        Bundle bundle = new Bundle();
        bundle.putString("MyValue", "router_att");
        intent.putExtras(bundle);
        startActivity(intent);
    }
    public void openActivity_setting() {

        Intent intent = new Intent(this,MasaiSettingActivity.class);
        startActivity(intent);
    }


    public void openActivity_bluetooth_att() {

        Intent intent = new Intent(this,Bluetooth_attackActivity.class);
        startActivity(intent);
    }

    private boolean isRemoteDeviceConnected() {
        if(mBluetoothManagementService != null && mBound) {
            return mBluetoothManagementService.isRemoteDeviceConnected();
        }
        return false;
//        return true;
    }

    private void showRequiredConnection() {
        Toast.makeText(mContext, "Please connect to MASai Box", Toast.LENGTH_SHORT).show();
    }
}